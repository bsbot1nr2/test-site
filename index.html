<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VPN Check</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
    }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 1rem;
      padding: 2rem 2.5rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
      text-align: center;
    }
    h1 {
      margin: 0 0 0.75rem 0;
      font-size: 1.6rem;
    }
    p { margin: 0.25rem 0; line-height: 1.5; }

    .status {
      margin-top: 1.25rem;
      padding: 1rem;
      border-radius: 0.75rem;
      font-size: 1.05rem;
      font-weight: 600;
    }
    .loading { background: rgba(30,41,59,0.8); border: 1px dashed rgba(148,163,184,0.6); }
    .warn    { background: rgba(220,38,38,0.15); border: 1px solid rgba(248,113,113,0.9); color: #fecaca; }
    .info    { background: rgba(245,158,11,0.15); border: 1px solid rgba(251,191,36,0.9); color: #fef3c7; }
    .ok      { background: rgba(22,163,74,0.18); border: 1px solid rgba(34,197,94,0.9); color: #bbf7d0; }

    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: #2563eb;
      color: white;
    }
    button.secondary { background: #475569; }
    .hidden { display: none !important; }

    #content {
      display: none;
      margin-top: 30px;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="card" id="checker">
    <h1>VPN Check</h1>
    <p>Your connection is being checked for VPN or proxy usage.</p>

    <div id="status" class="status loading">
      Checking your connection…
    </div>

    <button id="reloadBtn">Check again</button>
    <button id="dismissBtn" class="secondary hidden">I disabled it</button>
  </div>

  <div id="content">
    <h2>Welcome!</h2>
    <p>This is the example content that appears once no VPN/proxy is detected.</p>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const reloadBtn = document.getElementById("reloadBtn");
    const dismissBtn = document.getElementById("dismissBtn");
    const checker = document.getElementById("checker");
    const content = document.getElementById("content");

    const DC_KEY = "dc_warning_dismissed";

    // Sends logs to your Vercel backend (api/log-vpn.js)
    function sendLogToBackend(data) {
      fetch("/api/log-vpn", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).catch(err => console.warn("failed to send log:", err));
    }

    async function checkVpn() {
      statusEl.textContent = "Checking your connection…";
      statusEl.className = "status loading";
      reloadBtn.disabled = true;
      dismissBtn.classList.add("hidden");

      try {
        const res = await fetch("https://api.ipapi.is");
        const data = await res.json();

        reloadBtn.disabled = false;

        const timestamp = new Date().toISOString();
        const dismissed = localStorage.getItem(DC_KEY) === "1";

        const ip = data.ip || "unknown";
        const vpn = data.is_vpn === true;
        const proxy = data.is_proxy === true;
        const datacenter = data.is_datacenter === true;

        // Send log to backend
        sendLogToBackend({
          ip,
          vpn,
          proxy,
          datacenter,
          dismissed,
          userAgent: navigator.userAgent,
          timestamp
        });

        if (vpn || proxy) {
          statusEl.textContent =
            "VPN or proxy detected — please disable it and press 'Check again'.";
          statusEl.className = "status warn";
          return;
        }

        if (datacenter && !dismissed) {
          statusEl.textContent =
            "You may be using a VPN or server IP. If it is disabled, press 'I disabled it'.";
          statusEl.className = "status info";
          dismissBtn.classList.remove("hidden");
          return;
        }

        // Success
        statusEl.textContent = "No VPN detected. You can continue.";
        statusEl.className = "status ok";

        setTimeout(() => {
          checker.classList.add("hidden");
          content.style.display = "block";
        }, 500);

      } catch (err) {
        console.error(err);
        reloadBtn.disabled = false;
        statusEl.textContent = "Error checking connection. Try again.";
        statusEl.className = "status warn";
      }
    }

    reloadBtn.addEventListener("click", checkVpn);

    dismissBtn.addEventListener("click", () => {
      localStorage.setItem(DC_KEY, "1");
      checker.classList.add("hidden");
      content.style.display = "block";
    });

    // Run on load
    checkVpn();
  </script>
</body>
</html>
